name: Deploy ke VPS

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout kode
        uses: actions/checkout@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      
      - name: Build Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          push: false
          load: true
          tags: backendgame:latest
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Deploy ke VPS
        run: |
          # Nonaktifkan pemeriksaan host key untuk memudahkan koneksi pertama
          mkdir -p ~/.ssh
          echo "StrictHostKeyChecking no" > ~/.ssh/config
          
          # Salin file docker-compose.yml ke VPS
          scp docker-compose.yml vazzuniverse@103.127.98.128:~/
          
          # Jalankan docker-compose di VPS
          ssh vazzuniverse@103.127.98.128 '
            
            # Jalankan docker-compose
            cd ~/ && docker compose up -d
          '